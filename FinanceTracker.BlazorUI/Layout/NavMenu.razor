@using FinanceTracker.BlazorUI.Services.Auth
@inject AuthState AuthState
@inject NavigationManager NavigationManager

<MudDrawer @bind-Open="_drawerOpen"
           ClipMode="DrawerClipMode.Never"
           Variant="DrawerVariant.Responsive"
           Elevation="1"
           Class="mud-width-250">
    <MudNavMenu>
        <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
            Home
        </MudNavLink>

        <MudNavLink Href="/wallets" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccountBalanceWallet">
            Wallets
        </MudNavLink>

        <MudNavLink Href="/operation-types" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Category">
            Operation types (Income/Expense)
        </MudNavLink>

        <MudNavLink Href="/operations" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ListAlt">
            Operations
        </MudNavLink>

        <MudNavLink Href="/reports" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Assessment">
            Reports
        </MudNavLink>
    </MudNavMenu>
</MudDrawer>

<MudAppBar Color="Color.Primary" Elevation="1">
    <MudIconButton Icon="@Icons.Material.Filled.Menu"
                   Color="Color.Inherit"
                   Edge="Edge.Start"
                   OnClick="ToggleDrawer" />
    <MudText Typo="Typo.h6">FinanceTracker</MudText>
    <MudSpacer />
    
    @if (!AuthState.IsAuthenticated)
    {
        <MudButton Color="Color.Inherit"
                   Variant="Variant.Text"
                   OnClick="@(() => NavigationManager.NavigateTo("/login"))">
                   Login
        </MudButton>

        <MudButton Color="Color.Inherit"
                   Variant="Variant.Outlined"
                   Class="ml-2"
                   OnClick="@(() => NavigationManager.NavigateTo("/register"))">
                   Register
        </MudButton>
    }
    else
    {
        <MudMenu>
            <ActivatorContent>
                <MudAvatar Class="cursor-pointer">
                    <MudIcon Size="Size.Medium" Icon="@Icons.Material.Filled.Person" />
                </MudAvatar>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem Href="/profile">Profile</MudMenuItem>
                <MudMenuItem OnClick="LogoutAsync">Logout</MudMenuItem>
            </ChildContent>
        </MudMenu>
    }

</MudAppBar>

@code {
    private bool _drawerOpen = true;
    private bool _isAuthInitialized;

    protected override async Task OnInitializedAsync()
    {
        await AuthState.EnsureInitializedAsync();
        _isAuthInitialized = true;
    }


    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task LogoutAsync()
    {
        await AuthState.ClearAsync();
        NavigationManager.NavigateTo("/login");
    }
}
